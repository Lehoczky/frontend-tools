import{p as y,a as d,m as h,c as u,b as v}from"./navigation.0386e11b.js";import{Q as f,a3 as b,a0 as $}from"./entry.a6c8cc0b.js";import{c as I}from"./utils.74d1f658.js";import{u as p}from"./preview.cf3e4dac.js";import"./index.a6ef77ff.js";const _=e=>b(e,f().public.content.api.baseURL),C=y(d({driver:h()}),"@content");function k(e){async function i(){const t=new Set(await e.getKeys("cache:")),s=p().getPreviewToken();if(s){const r=await e.getItem(`${s}$`).then(a=>a||{});if(Array.isArray(r.ignoreSources)){const a=r.ignoreSources.map(c=>`cache:${c.trim()}:`);for(const c of t)a.some(w=>c.startsWith(w))&&t.delete(c)}const n=await e.getKeys(`${s}:`),g=await Promise.all(n.map(a=>e.getItem(a)));for(const a of g)t.delete(`cache:${a._id}`),a.__deleted||t.add(`${s}:${a._id}`)}return await Promise.all(Array.from(t).map(r=>e.getItem(r)))}return{storage:e,fetch:u(i),query:t=>I(u(i),{initialParams:t,legacy:!1})}}let l=null,m=null;async function P(){return m?await m:l||(m=D(),l=await m),l}async function D(){const e=$(),{content:i}=f().public,t=k(C),s=await t.storage.getItem("integrity");if(i.integrity!==+(s||0)){const{contents:o,navigation:r}=await $fetch(_(i.integrity?`cache.${i.integrity}.json`:"cache.json"));await Promise.all(o.map(n=>t.storage.setItem(`cache:${n._id}`,n))),await t.storage.setItem("navigation",r),await t.storage.setItem("integrity",i.integrity)}return await e.callHook("content:storage",t.storage),t}async function K(e){const i=await P();if(!p().getPreviewToken()&&Object.keys(e||{}).length===0)return i.storage.getItem("navigation");const t=await i.query(e).where({_partial:!1,navigation:{$ne:!1}}).find(),o=(await i.query().where({_path:/\/_dir$/i,_partial:!0}).find()).result.reduce((r,n)=>{var a;((a=n.title)==null?void 0:a.toLowerCase())==="dir"&&(n.title=void 0);const g=n._path.split("/").slice(0,-1).join("/")||"/";return r[g]={...n,...n.body},r},{});return v((t==null?void 0:t.result)||t,o)}export{C as contentStorage,k as createDB,K as generateNavigation,P as useContentDatabase};
