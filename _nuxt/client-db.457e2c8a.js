import{c as y,p as d,a as h,m as v,b as _}from"./navigation.5e3c256f.js";import{P as p,a2 as $,$ as b}from"./entry.13f4dc9c.js";import{c as C}from"./utils.996050f3.js";import{u as f}from"./preview.10a65edc.js";import"./index.a6ef77ff.js";function l(e){const a=y(e);return async t=>{var n;const o=t.params(),i=await a(t);return o.surround?i.surround:(i.dirConfig&&(i.result={_path:(n=i.dirConfig)==null?void 0:n._path,...i.result,_dir:i.dirConfig}),i.result)}}const I=e=>$(e,p().public.content.api.baseURL),P=d(h({driver:v()}),"@content");function k(e){async function a(){const t=new Set(await e.getKeys("cache:")),o=f().getPreviewToken();if(o){const n=await e.getItem(`${o}$`).then(r=>r||{});if(Array.isArray(n.ignoreSources)){const r=n.ignoreSources.map(c=>`cache:${c.trim()}:`);for(const c of t)r.some(w=>c.startsWith(w))&&t.delete(c)}const s=await e.getKeys(`${o}:`),g=await Promise.all(s.map(r=>e.getItem(r)));for(const r of g)t.delete(`cache:${r._id}`),r.__deleted||t.add(`${o}:${r._id}`)}return await Promise.all(Array.from(t).map(n=>e.getItem(n)))}return{storage:e,fetch:l(a),query:t=>C(l(a),{initialParams:t,legacy:!0})}}let m=null,u=null;async function D(){return u?await u:m||(u=S(),m=await u),m}async function S(){const e=b(),{content:a}=p().public,t=k(P),o=await t.storage.getItem("integrity");if(a.integrity!==+(o||0)){const{contents:i,navigation:n}=await $fetch(I(a.integrity?`cache.${a.integrity}.json`:"cache.json"));await Promise.all(i.map(s=>t.storage.setItem(`cache:${s._id}`,s))),await t.storage.setItem("navigation",n),await t.storage.setItem("integrity",a.integrity)}return await e.callHook("content:storage",t.storage),t}async function K(e){const a=await D();if(!f().getPreviewToken()&&Object.keys(e||{}).length===0)return a.storage.getItem("navigation");const t=await a.query(e).where({_partial:!1,navigation:{$ne:!1}}).find(),i=(await a.query().where({_path:/\/_dir$/i,_partial:!0}).find()).reduce((n,s)=>{var r;((r=s.title)==null?void 0:r.toLowerCase())==="dir"&&(s.title=void 0);const g=s._path.split("/").slice(0,-1).join("/")||"/";return n[g]={...s,...s.body},n},{});return _(t,i)}export{P as contentStorage,k as createDB,K as generateNavigation,D as useContentDatabase};
